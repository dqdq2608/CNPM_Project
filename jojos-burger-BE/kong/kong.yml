_format_version: "3.0"
_transform: true

services:
  - name: internal-ping
    url: http://does-not-matter.local # sẽ bị chặn trước khi gọi
    routes:
      - name: internal-ping-route
        paths: ["/internal/ping"]
        strip_path: true
        tags: ["internal", "test"]
    plugins:
      - name: key-auth
        config:
          key_names: ["apikey"]
          run_on_preflight: true
      - name: request-termination
        config:
          status_code: 200
          content_type: application/json
          body: '{"ok": true, "via": "kong", "route": "/internal/ping"}'

  # === CATALOG qua Kong ===
  - name: catalog
    url: http://catalog-api:8080
    routes:
      - name: catalog-route
        paths:
          - /api/catalog
        strip_path: false
        methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    plugins:
      - name: cors
        config:
          origins:
            - https://localhost:3000
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
          headers:
            - "*"
          exposed_headers:
            - "*"
          credentials: false
          max_age: 3600

  # === ORDERING API qua Kong ===
  - name: ordering-api
    url: http://ordering-api:8080
    routes:
      - name: ordering-route
        # OrdersApi đang map "api/orders" nên mình để path y chang
        paths:
          - /api/orders
        strip_path: false
        methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]

  # === BASKET API ===
  - name: basket-api
    url: http://basket-api:8080
    routes:
      - name: basket-route
        paths:
          - /basket-api
        strip_path: true
        methods: ["GET", "POST", "DELETE", "OPTIONS"]

  # === PAYMENT PROCESSOR ===
  - name: payment-service
    url: http://paymentprocessor:5226
    routes:
      - name: payment-route
        paths:
          - /api/payments
        methods:
          - GET
          - POST
        strip_path: false


  # === WEBHOOK từ PayOS vào ===
  - name: payment-webhook-service
    host: webhookreceiver
    port: 5022
    protocol: http
    path: /webhooks
    routes:
      - name: payos-webhook
        paths:
          - /api/payment/webhooks
        methods: [ "POST" ]
        strip_path: true

consumers:
  - username: bff
    keyauth_credentials:
      - key: "bff-internal-api-key"

plugins:
  - name: prometheus
