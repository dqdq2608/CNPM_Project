services:
  # === IdentityServer (IDS) ===
  ids:
    build:
      context: ./services/IdentityServerLogic
      dockerfile: Dockerfile
    container_name: ids
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_URLS: "https://+:5001"
      ASPNETCORE_Kestrel__Certificates__Default__Path: "/https/localhost.pem"
      ASPNETCORE_Kestrel__Certificates__Default__KeyPath: "/https/localhost-key.pem"
      DISABLE_HTTPS_REDIRECT: "false"
      ConnectionStrings__Default: "Data Source=/data/IdentityServer.db"
    volumes:
      - ids_data:/data
      - ./certs:/https:ro
    ports:
      - "5001:5001"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsSk https://localhost:5001/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s
    networks: [appnet]

  # === BFF ===
  bff:
    build:
      context: ./services/IdentityServerBFF
      dockerfile: Dockerfile
    container_name: bff
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_URLS: "https://+:7082"
      ASPNETCORE_Kestrel__Certificates__Default__Path: "/https/localhost.pem"
      ASPNETCORE_Kestrel__Certificates__Default__KeyPath: "/https/localhost-key.pem"

      BFF__Authority: "https://ids:5001"
      BFF__ClientId: "bff_ro"
      BFF__ClientSecret: "super-secret"
      BFF__Scopes__0: "openid"
      BFF__Scopes__1: "profile"
      BFF__Scopes__2: "email"
      BFF__Scopes__3: "roles"
      BFF__Scopes__4: "offline_access"
      BFF__Scopes__5: "api"

      Kong__Url: "http://kong:8000"
      Kong__ApiKey: "bff-internal-api-key"
    depends_on:
      ids:
        condition: service_healthy
    volumes:
      - ./certs:/https:ro
    ports:
      - "7082:7082"
    networks: [appnet]

  # === Kong (DB-less) ===
  kong:
    image: kong:3.7
    container_name: kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_LISTEN: "0.0.0.0:8443 ssl, 0.0.0.0:8000"
      KONG_SSL_CERT: /certs/localhost.pem
      KONG_SSL_CERT_KEY: /certs/localhost-key.pem
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_LOG_LEVEL: info
    volumes:
      - ./kong/kong.yml:/kong/kong.yml:ro
      - ./certs:/certs:ro
    ports:
      - "8443:8443"
      - "8001:8001"
    depends_on:
      - bff
      - ids
    networks: [appnet]

  webhook-receiver:
    build:
      context: ./services/WebhookReceiver
      dockerfile: Dockerfile
    container_name: webhook-receiver
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      # đặt secret nếu muốn bật HMAC verify (khớp với token khi đăng ký ở eShop)
      Webhooks__Secret: "${WEBHOOKS_SECRET:-}"   # để trống cũng được
    ports:
      - "6105:6105"        # mở ra host để bạn test; prod có thể bỏ
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:6105/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks: [appnet]

  webhook-publisher:
    build:
      context: ./services/WebhookPublisher
    container_name: webhook-publisher
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
    ports: ["6110:6110"]
    networks: [appnet]

networks:
  appnet: {}

volumes:
  ids_data:
