version: "3.9"

services:
  # === IdentityServer (IDS) ===
  ids:
    build:
      context: ./services/IdentityServerLogic
      dockerfile: Dockerfile
    container_name: ids
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_URLS: "https://+:5001"
      ASPNETCORE_Kestrel__Certificates__Default__Path: "/https/localhost.pem"
      ASPNETCORE_Kestrel__Certificates__Default__KeyPath: "/https/localhost-key.pem"
      DISABLE_HTTPS_REDIRECT: "false"
      ConnectionStrings__Default: "Data Source=/data/IdentityServer.db"
    volumes:
      - ids_data:/data
      - ./certs:/https:ro
    ports:
      - "5001:5001"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsSk https://localhost:5001/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s
    networks: [appnet]

  # === BFF ===
  bff:
    build:
      context: ./services/IdentityServerBFF
      dockerfile: Dockerfile
    container_name: bff
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_URLS: "https://+:7082"
      ASPNETCORE_Kestrel__Certificates__Default__Path: "/https/localhost.pem"
      ASPNETCORE_Kestrel__Certificates__Default__KeyPath: "/https/localhost-key.pem"

      Basket__BaseUrl: "http://basket-api:8080"
      Ordering__BaseUrl: "http://ordering-api:8080" 
      Delivery__BaseUrl: "http://delivery-api:8080"

      BFF__Authority: "https://ids:5001"  
      BFF__ClientId: "bff_ro"
      BFF__ClientSecret: "super-secret"
      BFF__Scopes__0: "openid"
      BFF__Scopes__1: "profile"
      BFF__Scopes__2: "email"
      BFF__Scopes__3: "roles"
      BFF__Scopes__4: "offline_access"
      BFF__Scopes__5: "api"

      Kong__Url: "http://kong:8000"
      Kong__ApiKey: "bff-internal-api-key"
    depends_on:
      ids:
        condition: service_healthy
    volumes:
      - ./certs:/https:ro
    ports:
      - "7082:7082"
    networks: [appnet]

  # === Kong (DB-less) ===
  kong:
    image: kong:3.7
    container_name: kong
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/kong.yml
      KONG_PROXY_LISTEN: "0.0.0.0:8443 ssl, 0.0.0.0:8000"
      KONG_SSL_CERT: /certs/localhost.pem
      KONG_SSL_CERT_KEY: /certs/localhost-key.pem
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_LOG_LEVEL: info
    volumes:
      - ./kong/kong.yml:/kong/kong.yml:ro
      - ./certs:/certs:ro
    ports:
      - "8443:8443"
      - "8001:8001"
    depends_on:
      - bff
      - ids
    networks: [appnet]

  # === RabbitMQ (Event Bus) ===
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    ports:
      - "5672:5672"    # AMQP
      - "15672:15672"  # UI: http://localhost:15672
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks: [appnet]

  # === Payment Processor ===
  paymentprocessor:
    build:
      context: .
      dockerfile: services/PaymentProcessor/Dockerfile
    container_name: paymentprocessor
    environment:
      ASPNETCORE_URLS: http://+:5226
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__EventBus: "amqp://guest:guest@rabbitmq:5672"
    ports:
      - "5226:5226"
    depends_on:
      - rabbitmq
    networks: [appnet]

  # === Webhook Receiver ===
  webhookreceiver:
    build:
      context: .
      dockerfile: services/WebhookReceiver/Dockerfile
    container_name: webhookreceiver
    environment:
      ASPNETCORE_URLS: http://+:5022
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__EventBus: "amqp://guest:guest@rabbitmq:5672"
      EventBus__SubscriptionClientName: "webhookreceiver"
    ports:
      - "5022:5022"
    depends_on:
      - rabbitmq
    networks: [appnet]

  # === Catalog DB (PostgreSQL) ===
  catalog-db:
    build:
      context: .
      dockerfile: db/Dockerfile.db
    container_name: catalog-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-catalogdb}
    ports:
      - "5435:5432"
    volumes:
      - catalog_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-catalogdb}"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks: [appnet]

  # === Catalog API ===
  catalog-api:
    build:
      context: .
      dockerfile: services/Catalog.API/Dockerfile
    container_name: catalog-api
    depends_on:
      catalog-db:
        condition: service_healthy
    env_file: .env
    environment:
      ConnectionStrings__catalogdb: "Host=catalog-db;Port=5432;Database=${POSTGRES_DB:-catalogdb};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-postgres};Include Error Detail=true"
    ports:
      - "7002:8080"
    networks: [appnet]

  # === Basket Redis ===
  basket-redis:
    image: redis:7
    container_name: basket-redis
    ports:
      - "6379:6379"
    networks: [appnet]

  # === Basket API ===
  basket-api:
    build:
      context: .
      dockerfile: services/Basket.API/Dockerfile
    container_name: basket-api
    depends_on:
      basket-redis:
        condition: service_started
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ConnectionStrings__Redis: "basket-redis:6379"
    ports:
      - "5005:8080"   # Swagger: http://localhost:5005
    networks: [appnet]

  # === Ordering DB (PostgreSQL) ===
  ordering-db:
    image: postgres:16
    container_name: ordering-db
    environment:
      POSTGRES_USER: ordering
      POSTGRES_PASSWORD: ordering_pwd
      POSTGRES_DB: orderingdb
    ports:
      - "5436:5432"   # optional: để debug từ host
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ordering -d orderingdb"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks: [appnet]

  # === Ordering API ===
  ordering-api:
    build:
      context: .
      dockerfile: services/Ordering/Ordering.API/Dockerfile
    container_name: ordering-api
    depends_on:
      ordering-db:
        condition: service_healthy
      rabbitmq:
        condition: service_started
    environment:
      ASPNETCORE_ENVIRONMENT: "Development"
      ASPNETCORE_URLS: "http://+:8080"

      # phải trùng key "OrderingDb" trong Program.cs / appsettings
      ConnectionStrings__OrderingDb: "Host=ordering-db;Port=5432;Database=orderingdb;Username=ordering;Password=ordering_pwd;Include Error Detail=true"

      # EventBus (RabbitMQ)
      ConnectionStrings__EventBus: "amqp://guest:guest@rabbitmq:5672"
    ports:
      - "5224:8080"   # http://localhost:5224
    networks: [appnet]
  
  ngrok:
    image: ngrok/ngrok:latest
    container_name: ngrok
    # forward HTTP traffic từ internet → service webhookreceiver:5022 trong docker network
    command: http webhookreceiver:5022
    environment:
      NGROK_AUTHTOKEN: 35rz5l4F3SkbCy23YLdN3io6Fpb_5rkqSGwnCmEXJTVB7C43f
    ports:
      - "4040:4040"   # UI của ngrok để xem log, request…
    depends_on:
      - webhookreceiver
    networks: [appnet]

  # === Delivery DB ===
  delivery-db:
    image: postgres:16
    container_name: delivery-db
    restart: always
    environment:
      POSTGRES_USER: delivery
      POSTGRES_PASSWORD: Pass@word1
      POSTGRES_DB: deliverydb
    ports:
      - "5437:5432"
    volumes:
      - delivery-data:/var/lib/postgresql/data
    networks: [appnet]

  # === Delivery API ===
  delivery-api:
    image: delivery-api
    container_name: delivery-api
    build:
      context: .
      dockerfile: services/Delivery/Delivery.API/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DeliveryDb: "Host=delivery-db;Port=5432;Database=deliverydb;Username=delivery;Password=Pass@word1"
    depends_on:
      - delivery-db
    ports:
      - "5010:8080"
    networks: [appnet]   
    
networks:
  appnet: {}

volumes:
  ids_data:
  catalog_pgdata:
  ordering_pgdata:
  delivery-data:
